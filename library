local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- Configuration
local AUTH_URL = "https://sentinel-auth.onrender.com/verify"

-- 1. GET VARIABLES FROM GETGENV
local env = (getgenv and getgenv()) or _G
local UserKey = env.Key
local ScriptName = env.Script -- This is the NAME (e.g., "DaHood")

-- 2. UI Helper
local function Notify(title, text, duration)
    game.StarterGui:SetCore("SendNotification", {
        Title = Sentinel;
        Text = loading;
        Duration = duration or 5;
    })
end

-- 3. Validation
if not UserKey or UserKey == "" then
    LocalPlayer:Kick("Sentinel: Missing 'getgenv().Key'.")
    return
end

if not ScriptName or ScriptName == "" then
    LocalPlayer:Kick("Sentinel: Missing 'getgenv().Script' name.")
    return
end

Notify("Sentinel", "Authenticating...", 3)

-- 4. Authentication Request (Sends Key + Script Name)
local success, response = pcall(function()
    local requestFunc = (syn and syn.request) or (http and http.request) or (http_request) or (fluxus and fluxus.request) or request
    
    local body = HttpService:JSONEncode({
        key = UserKey,
        script_name = ScriptName 
    })

    if requestFunc then
        return requestFunc({
            Url = AUTH_URL,
            Method = "POST",
            Headers = { ["Content-Type"] = "application/json" },
            Body = body
        })
    else
        return {
            Body = game:HttpPost(AUTH_URL, body, true)
        }
    end
end)

-- 5. Handle Server Response
if success and response then
    local data
    local parseSuccess, _ = pcall(function()
        data = HttpService:JSONDecode(response.Body)
    end)

    if not parseSuccess then
        Notify("Error", "Invalid server response.", 5)
        return
    end

    if data.success then
        Notify("Sentinel", "Success! Loading Script...", 3)
        
        -- 6. RUN THE CODE SENT BY SERVER
        local scriptCode = data.script_code
        if scriptCode and scriptCode ~= "" then
            local runSuccess, runError = pcall(function()
                loadstring(scriptCode)()
            end)
            
            if not runSuccess then
                warn("Sentinel: Error running server code: " .. tostring(runError))
                Notify("Error", "Script failed to run.", 5)
            end
        else
            Notify("Error", "Server returned no code for '" .. tostring(ScriptName) .. "'", 5)
        end
    else
        LocalPlayer:Kick("Sentinel: " .. (data.message or "Invalid Key or Script Name"))
    end
else
    Notify("Error", "Server Connection Failed", 5)
end
