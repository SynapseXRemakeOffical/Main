local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- Configuration
local AUTH_URL = "https://sentinel-auth.onrender.com/verify"

-- 1. GET VARIABLES FROM GETGENV
-- We use a pcall to ensure getgenv exists (standard in most exploits)
local env = (getgenv and getgenv()) or _G
local UserKey = env.Key
local TargetScript = env.Script

-- 2. UI Helper
local function Notify(title, text, duration)
    game.StarterGui:SetCore("SendNotification", {
        Title = title;
        Text = text;
        Duration = duration or 5;
    })
end

-- 3. Pre-Auth Validation
if not UserKey or UserKey == "" then
    LocalPlayer:Kick("Sentinel Auth: Missing 'getgenv().Key'. Please use the correct loader.")
    return
end

Notify("Sentinel", "Verifying Key...", 2)

-- 4. Authentication Logic
local success, response = pcall(function()
    local requestFunc = (syn and syn.request) or (http and http.request) or (http_request) or (fluxus and fluxus.request) or request
    
    if requestFunc then
        return requestFunc({
            Url = AUTH_URL,
            Method = "POST",
            Headers = { ["Content-Type"] = "application/json" },
            Body = HttpService:JSONEncode({ key = UserKey })
        })
    else
        -- Fallback for weaker executors
        return {
            Body = game:HttpPost(AUTH_URL, HttpService:JSONEncode({key = UserKey}), true)
        }
    end
end)

-- 5. Handle Server Response
if success and response then
    local data
    local jsonSuccess, _ = pcall(function()
        data = HttpService:JSONDecode(response.Body)
    end)

    if not jsonSuccess then
        Notify("Error", "Invalid server response.", 5)
        return
    end

    if data.success then
        Notify("Sentinel", "Authenticated!", 3)
        
        -- 6. EXECUTE THE TARGET SCRIPT
        if TargetScript then
            local runSuccess, runError = pcall(function()
                if type(TargetScript) == "string" then
                    -- Check if it's a URL (starts with http) or raw Lua code
                    if TargetScript:match("^http") then
                        loadstring(game:HttpGet(TargetScript))()
                    else
                        loadstring(TargetScript)()
                    end
                elseif type(TargetScript) == "function" then
                    TargetScript()
                end
            end)
            
            if not runSuccess then
                warn("Sentinel: Error running target script: " .. tostring(runError))
                Notify("Error", "Failed to load script (Check Console)", 5)
            end
        else
            warn("Sentinel: Key valid, but 'getgenv().Script' was empty.")
            Notify("Sentinel", "No script provided to load.", 5)
        end
    else
        -- Kick user if key is invalid
        LocalPlayer:Kick("Sentinel Auth: " .. (data.message or "Invalid Key"))
    end
else
    Notify("Error", "Server Connection Failed", 5)
end
