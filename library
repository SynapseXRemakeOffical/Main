-- ============================================
-- SENTINEL LOADER v4.2 - Maximum Security
-- ============================================
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")

-- Anti-tamper / env check
local startTime = tick()
local counter = 0
local conn = RunService.Heartbeat:Connect(function() counter += 1 end)
repeat task.wait() until counter >= 3 or tick() - startTime > 2
conn:Disconnect()

if counter < 2 then
    LocalPlayer:Kick("âŒ Sentinel: Environment tamper detected")
    return
end

-- Config
local AUTH_URL = "https://sentinel-auth.onrender.com/api/v1/verify"  -- Replace with your Render URL

-- Get env vars
local env = getgenv and getgenv() or _G
local UserKey = env.Key
local ScriptName = env.Script or "default"

-- HWID generation (fingerprint)
local function getHWID()
    local parts = {}
    pcall(function()
        table.insert(parts, game:GetService("RbxAnalyticsService"):GetClientId() or "nil")
        table.insert(parts, identifyexecutor and identifyexecutor() or "unknown")
        table.insert(parts, syn and "syn" or http_request and "http" or "unknown")
    end)
    local combined = table.concat(parts, "|")
    return HttpService:GenerateGUID(false):upper():sub(1, 32)  -- Fallback + hash
end

local hwid = getHWID()

-- Notify helper
local function Notify(title, text, duration)
    pcall(function()
        game.StarterGui:SetCore("SendNotification", {Title = title, Text = text, Duration = duration or 5})
    end)
end

-- Validation
if not UserKey or UserKey == "" then
    LocalPlayer:Kick("âŒ Sentinel: Missing License Key\nSet getgenv().Key = \"YOUR-KEY\"")
    return
end

Notify("Sentinel v4.2", "ðŸ” Authenticating... (HWID: " .. hwid:sub(1,8) .. "...)", 4)

-- Request
local success, response = pcall(function()
    local req = syn and syn.request or http and http.request or http_request or fluxus and fluxus.request or request or game.HttpPostAsync
    
    local body = HttpService:JSONEncode({
        key = UserKey,
        script_name = ScriptName,
        hwid = hwid,
        executor = identifyexecutor and identifyexecutor() or "unknown"
    })
    
    if req and type(req) == "function" then
        return req({
            Url = AUTH_URL,
            Method = "POST",
            Headers = {
                ["Content-Type"] = "application/json",
                ["User-Agent"] = "Sentinel/4.2 Roblox",
                ["X-Sentinel-HWID"] = hwid
            },
            Body = body
        })
    else
        local resp = game:HttpPost(AUTH_URL, body, true)
        return {Body = resp, StatusCode = 200}
    end
end)

if success and response and response.StatusCode == 200 then
    local data = HttpService:JSONDecode(response.Body)
    
    if data.success then
        Notify("Sentinel", "âœ… Authenticated! Loading " .. ScriptName, 3)
        
        local runSuccess, err = pcall(function()
            loadstring(data.script_code)()
        end)
        
        if not runSuccess then
            warn("[Sentinel] Execution error: " .. tostring(err))
            Notify("Error", "Script execution failed", 5)
        else
            print("[Sentinel] Loaded: " .. ScriptName)
            Notify("Success", "âœ… " .. ScriptName .. " loaded", 3)
        end
    else
        local msg = data.message or "Auth failed"
        Notify("Error", msg, 6)
        LocalPlayer:Kick("âŒ Sentinel: " .. msg)
    end
else
    Notify("Error", "Connection failed - check internet/executor", 6)
    LocalPlayer:Kick("âŒ Sentinel: Server connection failed")
end
